<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Hard Hat & Vest — Dashboard</title>

  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#071022">
<link rel="icon" href="icon-192.png">


  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    :root {
      --bg-dark:#071022; --panel-dark:#0e1a2a; --muted-dark:#9fb0c8;
      --accent:#00c2a8; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --bg-light:#f4f6f9; --panel-light:#fff; --muted-light:#4b5563;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{background:var(--bg-dark);color:#e6f0f6;transition:background .25s,color .25s}
    .container{max-width:1150px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .meta{margin:0;color:var(--muted-dark);font-size:13px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);border:none;color:#042022;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.alt{background:transparent;color:var(--muted-dark);border:1px solid rgba(255,255,255,0.04)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.04));
      padding:14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.03)}
    .label{color:var(--muted-dark);font-size:13px}
    .value{font-weight:700;font-size:16px}
    .big{font-size:22px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
    .ok{background:rgba(22,163,74,0.12);color:var(--ok)}
    .warn{background:rgba(245,158,11,0.08);color:var(--warn)}
    .danger{background:rgba(239,68,68,0.08);color:var(--danger)}
    #map{height:320px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    td,th{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    pre{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;color:var(--muted-dark);max-height:220px;overflow:auto}
    footer{margin-top:16px;color:var(--muted-dark);font-size:13px;text-align:center}
    body.light{background:var(--bg-light);color:#0b1220}
    body.light .card{background:var(--panel-light);box-shadow:0 6px 18px rgba(2,6,23,0.06);border:1px solid rgba(5,20,40,0.03);color:#0b1220}
    body.light .meta,body.light .label,body.light pre{color:var(--muted-light)}
    body.light .btn.alt{color:var(--muted-light);border:1px solid rgba(15,23,42,0.04)}
    @media(max-width:960px){.grid{grid-template-columns:1fr}#map{height:240px}}


    .btn-download {
  margin-top: 10px;
  padding: 8px 14px;
  border: none;
  background-color: #0078d7;
  color: white;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
}
.btn-download:hover {
  background-color: #005fa3;
}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Smart Hard Hat & Vest — Dashboard</h1>
        <div class="meta">ThingSpeak Channel <strong>3110127</strong> — auto-refresh every 15s</div>
      </div>
      <div class="controls">
        <div id="last" class="meta">Last: —</div>
        <button id="refreshBtn" class="btn">Refresh</button>
        <button id="clearLogBtn" class="btn alt">Clear Log</button>
        <button id="themeToggle" class="btn alt">Toggle Theme</button>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;gap:16px;align-items:center">
            <div>
              <div class="label">Worker ID</div>
              <div id="workerId" class="value big">—</div>
            </div>
            <div style="margin-left:auto;text-align:right">
              <div class="label"><b>SOS Status</b></div>
              <div id="sosBadge" class="badge ok">Safe</div>
              <div id="eventLabel" style="color:var(--muted-dark);font-size:13px;margin-top:6px"></div>
            </div>
          </div>

          <hr style="border:none;height:12px">

          <div style="display:flex;gap:14px;align-items:flex-start">
            <div style="flex:1;">
              <div class="label">Location (lat, lon)</div>
              <div id="location" class="value">—</div>
              <div class="meta" id="createdAt">—</div>

              <div style="margin-top:12px">
                <div class="label">Distance from Geofence</div>
                <div id="distance" class="value">N/A</div>
              </div>
            </div>

            <div style="width:220px;">
              <div class="label">Hardhat Status</div>
              <div id="hardhatState" class="value">—</div>

              <div style="margin-top:12px" class="label">Attendance</div>
              <div id="attState" class="value">—</div>

              <div style="margin-top:12px" class="label">Check-in Time</div>
              <div id="checkIn" class="value">—</div>

              <div style="margin-top:12px" class="label">Check-out Time</div>
              <div id="checkOut" class="value">—</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="label">Map (live)</div>
              <div class="meta">Leaflet + OpenStreetMap tiles</div>
            </div>
            <button id="centerBtn" class="btn alt">Center</button>
          </div>

          <div id="map" style="margin-top:8px"></div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <input id="gfLat" placeholder="Geofence lat" />
            <input id="gfLon" placeholder="Geofence lon" />
            <input id="gfRadius" placeholder="Radius (m)" style="width:110px" />
            <button id="setGfBtn" class="btn">Set</button>
            <button id="clearGfBtn" class="btn alt">Clear</button>
            <div style="margin-left:auto;color:var(--muted-dark)">Dist: <span id="distDisplay">N/A</span></div>
          </div>



<!-- ===== DTR TABLE ===== -->
<div class="card" style="margin-top:14px">
  <div class="label">Daily Time Record (DTR)</div>
  <table id="dtrTable">
    <thead>
      <tr>
        <th>Worker ID</th>
        <th>Check-in AM</th>
        <th>Check-out AM</th>
        <th>Check-in PM</th>
        <th>Check-out PM</th>
      </tr>
    </thead>
    <tbody id="dtrBody">
      <!-- rows will auto-fill -->
    </tbody>
  </table>
<button id="downloadDTRBtn" onclick="downloadDTR()" class="btn-download">Download DTR (CSV)</button>
</div>



        </div>
      </div>


      <div>
        <div class="card">
          <div class="label">Latest fields (feed)</div>
          <table>
            <tbody>
              <tr><td>Latitude</td><td id="f1">—</td></tr>
              <tr><td>Longitude</td><td id="f2">—</td></tr>
              <tr><td>Worker ID</td><td id="f3">—</td></tr>
              <tr><td>Hardhat Status</td><td id="f4">—</td></tr>
              <tr><td>Check-in Time</td><td id="f5">—</td></tr>
              <tr><td>Check-out Time</td><td id="f6">—</td></tr>
              <tr><td>SOS Status</td><td id="f7">—</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card" style="margin-top:12px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
    <div class="label">Auto Log (latest updates)</div>
    <div>
      <button id="downloadLogBtn" class="btn alt">Download Log</button>
    </div>
  </div>
  <pre id="autoLog">(waiting for first data...)</pre>
</div>

      </div>
    </div>

    <footer>Smart Hard Hat Dashboard • ThingSpeak Channel 3110127</footer>
  </div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/*********************
 SMART HARD HAT DASHBOARD
 With:
 ✅ Auto log + download
 ✅ Theme toggle
 ✅ Map + Geofence set/clear
 ✅ ThingSpeak auto refresh
 ✅ Red Geofence Alert when out of range
 ✅ Local-device timestamps for Check-in / Check-out (first time only per day)
**********************/

const CHANNEL_ID = 3110127;
const READ_API_KEY = "WYFJUWB1474DAOUZ";
const REFRESH_MS = 15000;
const LATEST_URL = () =>
  `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json?api_key=${READ_API_KEY}`;

// ========= DOM ELEMENTS =========
const fEls=[null, ...[1,2,3,4,5,6,7].map(i=>document.getElementById('f'+i))];
const logEl=document.getElementById('autoLog');
const workerIdEl=document.getElementById('workerId');
const locationEl=document.getElementById('location');
const createdAtEl=document.getElementById('createdAt');
const hardhatEl=document.getElementById('hardhatState');
const attEl=document.getElementById('attState');
const checkInEl=document.getElementById('checkIn');
const checkOutEl=document.getElementById('checkOut');
const sosBadge=document.getElementById('sosBadge');
const eventLabelEl=document.getElementById('eventLabel');
const lastEl=document.getElementById('last');
const distDisplay=document.getElementById('distDisplay');
const distanceEl=document.getElementById('distance');

// ========= AUTO LOG =========
function appendLog(txt){
  const ts=new Date().toLocaleString();
  const entry=`[${ts}]\n${txt}\n---------------------------\n`;
  logEl.textContent+=entry;
  logEl.scrollTop=logEl.scrollHeight;
  localStorage.setItem('shh_log',logEl.textContent);
}
if(localStorage.getItem('shh_log')) logEl.textContent=localStorage.getItem('shh_log');
document.getElementById('clearLogBtn').addEventListener('click',()=>{
  logEl.textContent='(Log cleared)\n';
  localStorage.removeItem('shh_log');
});
document.getElementById('downloadLogBtn').addEventListener('click',()=>{
  const blob=new Blob([logEl.textContent],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`SmartHardHat_Log_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
  a.click();
  URL.revokeObjectURL(url);
});

// ========= MAP + GEOFENCE =========
let geofence={
  lat: parseFloat(localStorage.getItem('gfLat')) || 11.5634879636174,
  lon: parseFloat(localStorage.getItem('gfLon')) || 124.40128319866496,
  radius: parseFloat(localStorage.getItem('gfRadius')) || 100
};

const map=L.map('map').setView([geofence.lat,geofence.lon],17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let workerMarker=null;
let siteMarker=L.marker([geofence.lat,geofence.lon]).addTo(map).bindPopup('Site center');
let fenceCircle=L.circle([geofence.lat,geofence.lon],{radius:geofence.radius,color:'#00c2a8',fillOpacity:0.06}).addTo(map);

document.getElementById('gfLat').value=geofence.lat.toFixed(6);
document.getElementById('gfLon').value=geofence.lon.toFixed(6);
document.getElementById('gfRadius').value=geofence.radius;

document.getElementById('setGfBtn').addEventListener('click',()=>{
  const lat=parseFloat(document.getElementById('gfLat').value);
  const lon=parseFloat(document.getElementById('gfLon').value);
  const rad=parseFloat(document.getElementById('gfRadius').value);
  if(isNaN(lat)||isNaN(lon)||isNaN(rad)){alert('Enter valid numbers');return;}

  geofence={lat,lon,radius:rad};
  localStorage.setItem('gfLat',lat);
  localStorage.setItem('gfLon',lon);
  localStorage.setItem('gfRadius',rad);

  if(!siteMarker){
    siteMarker=L.marker([lat,lon]).addTo(map).bindPopup('Site center');
  }else{
    siteMarker.setLatLng([lat,lon]).bindPopup('Site center (updated)');
  }

  if(!fenceCircle){
    fenceCircle=L.circle([lat,lon],{radius:rad,color:'#00c2a8',fillOpacity:0.06}).addTo(map);
  }else{
    fenceCircle.setLatLng([lat,lon]).setRadius(rad).setStyle({color:'#00c2a8'});
  }

  map.panTo([lat,lon]);
  appendLog(`Geofence set: ${lat}, ${lon} (r=${rad}m)`);
});

document.getElementById('clearGfBtn').addEventListener('click',()=>{
  if(fenceCircle){map.removeLayer(fenceCircle);fenceCircle=null;}
  if(siteMarker){map.removeLayer(siteMarker);siteMarker=null;}
  localStorage.removeItem('gfLat');
  localStorage.removeItem('gfLon');
  localStorage.removeItem('gfRadius');
  geofence={lat:null,lon:null,radius:0};
  distDisplay.textContent='N/A';
  distanceEl.textContent='N/A';
  appendLog('⚪ Geofence cleared');
});

// ========= PARSERS =========
function parseHardhat(v){const s=String(v||'').trim();return s==='1'?'Worn':s==='0'?'Removed':s;}
function parseSOS(v){const s=String(v||'').trim();if(s==='1')return{label:'Emergency',cls:'danger'};if(s==='0')return{label:'Safe',cls:'ok'};return{label:s,cls:'warn'};}
function formatTimeField(v){if(!v)return'—';if(/\d{2}:\d{2}:\d{2}/.test(v))return v;return v;}

// ========= FETCH LATEST =========
async function fetchLatest(){
  try{
    const res=await fetch(LATEST_URL());
    if(!res.ok)throw new Error(res.status);
    const data=await res.json();
    const lat=parseFloat(data.field1),lon=parseFloat(data.field2);
    const worker=data.field3||'—';
    const hardhat=parseHardhat(data.field4);
    // ===== Use local device time for check-in/check-out signals =====
    const checkInSignal = data.field5 && String(data.field5).trim() !== '0' && String(data.field5).trim() !== '—';
    const checkOutSignal = data.field6 && String(data.field6).trim() !== '0' && String(data.field6).trim() !== '—';
    const localTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    let checkIn = '—';
    let checkOut = '—';
    if (checkInSignal) checkIn = localTime;
    if (checkOutSignal) checkOut = localTime;

    const sos=parseSOS(data.field7);
    const created=data.created_at;

      workerIdEl.textContent=worker;
    hardhatEl.textContent=hardhat;
    sosBadge.textContent=sos.label;
    sosBadge.className='badge '+sos.cls;
    
    // Send Gmail alert when SOS = Emergency (rate-limited to avoid spam)
    if (sos.label === 'Emergency') {
      const lastSOS = parseInt(localStorage.getItem('lastSOS') || '0', 10);
      const now = Date.now();
      const MIN_GAP = 5 * 60 * 1000; // 5 minutes
      if (!lastSOS || (now - lastSOS) > MIN_GAP) {
        sendSOSAlert(worker, lat, lon);
        localStorage.setItem('lastSOS', String(now));
      } else {
        appendLog('SOS triggered but suppressed to avoid duplicate alerts');
      }
    }

    attEl.textContent=(checkInSignal)?'Checked In':(checkOutSignal)?'Checked Out':'—';
    checkInEl.textContent=checkIn;
    checkOutEl.textContent=checkOut;
    updateDTR(worker, checkIn, checkOut);
    locationEl.textContent=(lat&&lon)?lat.toFixed(6)+', '+lon.toFixed(6):'No GPS';
    createdAtEl.textContent='Recorded: '+new Date(created).toLocaleString();

    fEls.slice(1).forEach((el,i)=>el.textContent=data['field'+(i+1)]||'—');

    if(!isNaN(lat)&&!isNaN(lon)){
      if(workerMarker)workerMarker.setLatLng([lat,lon]);
      else workerMarker=L.marker([lat,lon]).addTo(map).bindPopup('Worker '+worker);

      // Distance + geofence color logic
      if(geofence.lat&&geofence.lon&&geofence.radius>0){
        const d=map.distance([geofence.lat,geofence.lon],[lat,lon]);
        const inside=d<=geofence.radius;
        distanceEl.textContent=d.toFixed(1)+' m';
        distDisplay.textContent=d.toFixed(1)+' m';

        // Change circle + text color
        if(fenceCircle){
          fenceCircle.setStyle({color: inside ? '#00c2a8' : '#ef4444'});
        }
        distanceEl.style.color = inside ? '' : 'var(--danger)';
      }
    }

    const logText=`Worker: ${worker}\nHardhat: ${hardhat}\nSOS: ${sos.label}\nCheck-in: ${checkIn}\nCheck-out: ${checkOut}\nLat: ${lat||0}, Lon: ${lon||0}`;
    appendLog(logText);
    lastEl.textContent='Last: '+new Date().toLocaleTimeString();
  }catch(e){
    appendLog(' Fetch error: '+e.message);
    lastEl.textContent='Last: error';
  }
}


// ===== DTR TABLE UPDATE =====
function updateDTR(worker, checkIn, checkOut) {
  const dtrBody = document.getElementById("dtrBody");
  const today = new Date().toLocaleDateString();
  const key = `${worker}-${today}`;
  
  // Load saved DTR data from localStorage
  let dtrData = JSON.parse(localStorage.getItem("dtrData") || "{}");

  // 🔹 Clear previous days automatically
  for (const k in dtrData) {
    if (dtrData[k].date !== today) delete dtrData[k];
  }

  // Initialize record for today if not existing
  if (!dtrData[key]) {
    dtrData[key] = { worker, date: today, amIn: "-", amOut: "-", pmIn: "-", pmOut: "-" };
  }

  const currentHour = new Date().getHours();

  // Only write times if the incoming check-in/out are actual local times (not '—')
  if (checkIn !== "—" && checkIn !== "0") {
    if (currentHour < 12) {
      if (!dtrData[key].amIn || dtrData[key].amIn === "-") dtrData[key].amIn = checkIn;
    } else {
      if (!dtrData[key].pmIn || dtrData[key].pmIn === "-") dtrData[key].pmIn = checkIn;
    }
  }

  if (checkOut !== "—" && checkOut !== "0") {
    if (currentHour < 12) {
      if (!dtrData[key].amOut || dtrData[key].amOut === "-") dtrData[key].amOut = checkOut;
    } else {
      if (!dtrData[key].pmOut || dtrData[key].pmOut === "-") dtrData[key].pmOut = checkOut;
    }
  }

  // Save updated data
  localStorage.setItem("dtrData", JSON.stringify(dtrData));

  // Render DTR table
  dtrBody.innerHTML = "";
  Object.values(dtrData).forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.worker}</td>
      <td>${row.amIn}</td>
      <td>${row.amOut}</td>
      <td>${row.pmIn}</td>
      <td>${row.pmOut}</td>
    `;
    dtrBody.appendChild(tr);
  });
}


// ===== DOWNLOAD DTR AS CSV =====
function downloadDTR() {
  let dtrData = JSON.parse(localStorage.getItem("dtrData") || "{}");
  if (Object.keys(dtrData).length === 0) {
    alert("No DTR data available to download yet.");
    return;
  }

  // CSV Header
  let csv = "Worker ID,Date,Check-in AM,Check-out AM,Check-in PM,Check-out PM\n";

  // Add each row
  Object.values(dtrData).forEach(row => {
    csv += `${row.worker},${row.date},${row.amIn},${row.amOut},${row.pmIn},${row.pmOut}\n`;
  });

  // Create downloadable CSV file
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const today = new Date().toLocaleDateString().replace(/\//g, "-");
  a.href = url;
  a.download = `DTR_${today}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}




// ========= REFRESH SYSTEM =========
document.getElementById('refreshBtn').addEventListener('click',fetchLatest);
fetchLatest();
setInterval(fetchLatest,REFRESH_MS);

// ========= THEME TOGGLE =========
const themeToggle=document.getElementById('themeToggle');
const savedTheme=localStorage.getItem('theme');
if(savedTheme==='light')document.body.classList.add('light');
themeToggle.addEventListener('click',()=>{
  document.body.classList.toggle('light');
  localStorage.setItem('theme',document.body.classList.contains('light')?'light':'dark');
});
</script>


<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  // Initialize EmailJS
  (function(){
      emailjs.init("fIMgh7jJT8jXGTBRW");  // Your Public Key
  })();
</script>


<script>
function sendSOSAlert(workerID, latitude, longitude) {
  const templateParams = {
    worker_id: workerID,
    location_link: `https://www.google.com/maps?q=${latitude},${longitude}`,
    message: ` SOS EMERGENCY ALERT! Worker ${workerID} activated SOS.\n\nLocation: https://www.google.com/maps?q=${latitude},${longitude}`
  };

  emailjs.send("service_wqy08m9", "template_392j1tj", templateParams)
    .then(function(response) {
       console.log(" SOS Email sent!", response.status, response.text);
       alert(" SOS alert sent via Gmail!");
    }, function(error) {
       console.error("❌ Email failed:", error);
       alert(" Failed to send SOS email. Check console.");
    });
}
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registered ✅"))
    .catch(err => console.error("Service Worker registration failed:", err));
}
</script>


</body>
</html>
