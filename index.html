<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Hard Hat & Vest — Dashboard</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#071022">
  <link rel="icon" href="icon-192.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    :root {
      --bg-dark:#071022; --panel-dark:#0e1a2a; --muted-dark:#9fb0c8;
      --accent:#00c2a8; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --bg-light:#f4f6f9; --panel-light:#fff; --muted-light:#4b5563;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{background:var(--bg-dark);color:#e6f0f6;transition:background .25s,color .25s}
    .container{max-width:1150px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .meta{margin:0;color:var(--muted-dark);font-size:13px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);border:none;color:#042022;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.alt{background:transparent;color:var(--muted-dark);border:1px solid rgba(255,255,255,0.04)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.04));
      padding:14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.03)}
    .label{color:var(--muted-dark);font-size:13px}
    .value{font-weight:700;font-size:16px}
    .big{font-size:22px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
    .ok{background:rgba(22,163,74,0.12);color:var(--ok)}
    .warn{background:rgba(245,158,11,0.08);color:var(--warn)}
    .danger{background:rgba(239,68,68,0.08);color:var(--danger)}
    #map{height:320px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    td,th{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    pre{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;color:var(--muted-dark);max-height:220px;overflow:auto}
    footer{margin-top:16px;color:var(--muted-dark);font-size:13px;text-align:center}
    body.light{background:var(--bg-light);color:#0b1220}
    body.light .card{background:var(--panel-light);box-shadow:0 6px 18px rgba(2,6,23,0.06);border:1px solid rgba(5,20,40,0.03);color:#0b1220}
    body.light .meta,body.light .label,body.light pre{color:var(--muted-light)}
    body.light .btn.alt{color:var(--muted-light);border:1px solid rgba(15,23,42,0.04)}
    @media(max-width:960px){.grid{grid-template-columns:1fr}#map{height:240px}}

    .btn-download {
      margin-top: 10px;
      padding: 8px 14px;
      border: none;
      background-color: #0078d7;
      color: white;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-download:hover {
      background-color: #005fa3;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Smart Hard Hat & Vest — Dashboard</h1>
      <div class="meta">ThingSpeak Channel <strong>3110127</strong> — auto-refresh every 15s</div>
    </div>
    <div class="controls">
      <div id="last" class="meta">Last: —</div>
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="clearLogBtn" class="btn alt">Clear Log</button>
      <button id="themeToggle" class="btn alt">Toggle Theme</button>
    </div>
  </header>

  <div class="grid">
    <div>
      <div class="card">
        <div style="display:flex;gap:16px;align-items:center">
          <div>
            <div class="label">Worker ID</div>
            <div id="workerId" class="value big">—</div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div class="label"><b>SOS Status</b></div>
            <div id="sosBadge" class="badge ok">Safe</div>
            <div id="eventLabel" style="color:var(--muted-dark);font-size:13px;margin-top:6px"></div>
          </div>
        </div>

        <hr style="border:none;height:12px">

        <div style="display:flex;gap:14px;align-items:flex-start">
          <div style="flex:1;">
            <div class="label">Location (lat, lon)</div>
            <div id="location" class="value">—</div>
            <div class="meta" id="createdAt">—</div>

            <div style="margin-top:12px">
              <div class="label">Distance from Geofence</div>
              <div id="distance" class="value">N/A</div>
            </div>
          </div>

          <div style="width:220px;">
            <div class="label">Hardhat Status</div>
            <div id="hardhatState" class="value">—</div>

            <div style="margin-top:12px" class="label">Attendance</div>
            <div id="attState" class="value">—</div>

            <div style="margin-top:12px" class="label">Check-in Time</div>
            <div id="checkIn" class="value">—</div>

            <div style="margin-top:12px" class="label">Check-out Time</div>
            <div id="checkOut" class="value">—</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="label">Map (live)</div>
            <div class="meta">Leaflet + OpenStreetMap tiles</div>
          </div>
          <button id="centerBtn" class="btn alt">Center</button>
        </div>

        <div id="map" style="margin-top:8px"></div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="gfLat" placeholder="Geofence lat" />
          <input id="gfLon" placeholder="Geofence lon" />
          <input id="gfRadius" placeholder="Radius (m)" style="width:110px" />
          <button id="setGfBtn" class="btn">Set</button>
          <button id="clearGfBtn" class="btn alt">Clear</button>
          <div style="margin-left:auto;color:var(--muted-dark)">Dist: <span id="distDisplay">N/A</span></div>
        </div>

      </div>
    </div>

    <div>
      <div class="card">
        <div class="label">Latest fields (feed)</div>
        <table>
          <tbody>
            <tr><td>Latitude</td><td id="f1">—</td></tr>
            <tr><td>Longitude</td><td id="f2">—</td></tr>
            <tr><td>Worker ID</td><td id="f3">—</td></tr>
            <tr><td>Hardhat Status</td><td id="f4">—</td></tr>
            <tr><td>Check-in Time</td><td id="f5">—</td></tr>
            <tr><td>Check-out Time</td><td id="f6">—</td></tr>
            <tr><td>SOS Status</td><td id="f7">—</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="label">Auto Log (latest updates)</div>
          <div>
            <button id="downloadLogBtn" class="btn alt">Download Log</button>
          </div>
        </div>
        <pre id="autoLog">(waiting for first data...)</pre>
      </div>

    </div>
  </div>

  <footer>Smart Hard Hat Dashboard • ThingSpeak Channel 3110127</footer>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/*********************
 SMART HARD HAT DASHBOARD
**********************/

const CHANNEL_ID = 3110127;
const READ_API_KEY = "WYFJUWB1474DAOUZ";
const REFRESH_MS = 15000;
const LATEST_URL = () =>
  `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json?api_key=${READ_API_KEY}`;

// ========= DOM ELEMENTS =========
const fEls=[null, ...[1,2,3,4,5,6,7].map(i=>document.getElementById('f'+i))];
const logEl=document.getElementById('autoLog');
const workerIdEl=document.getElementById('workerId');
const locationEl=document.getElementById('location');
const createdAtEl=document.getElementById('createdAt');
const hardhatEl=document.getElementById('hardhatState');
const attEl=document.getElementById('attState');
const checkInEl=document.getElementById('checkIn');
const checkOutEl=document.getElementById('checkOut');
const sosBadge=document.getElementById('sosBadge');
const lastEl=document.getElementById('last');
const distDisplay=document.getElementById('distDisplay');
const distanceEl=document.getElementById('distance');

// ========= AUTO LOG =========
function appendLog(txt){
  const ts=new Date().toLocaleString();
  const entry=`[${ts}]\n${txt}\n---------------------------\n`;
  logEl.textContent+=entry;
  logEl.scrollTop=logEl.scrollHeight;
  localStorage.setItem('shh_log',logEl.textContent);
}
if(localStorage.getItem('shh_log')) logEl.textContent=localStorage.getItem('shh_log');
document.getElementById('clearLogBtn').addEventListener('click',()=>{ logEl.textContent='(Log cleared)\n'; localStorage.removeItem('shh_log'); });
document.getElementById('downloadLogBtn').addEventListener('click',()=>{ 
  const blob=new Blob([logEl.textContent],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url;
  a.download=`SmartHardHat_Log_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`; a.click();
  URL.revokeObjectURL(url);
});

// ========= CUSTOM ICONS =========
const redIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

// ========= MAP + GEOFENCE =========
let geofence = {
  lat: parseFloat(localStorage.getItem('gfLat')) || 11.5634879636174,
  lon: parseFloat(localStorage.getItem('gfLon')) || 124.40128319866496,
  radius: parseFloat(localStorage.getItem('gfRadius')) || 100
};

const map = L.map('map').setView([geofence.lat, geofence.lon], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let workerMarker = null;
let siteMarker = L.marker([geofence.lat, geofence.lon], { icon: redIcon })
  .addTo(map)
  .bindPopup('Site center');

let fenceCircle = L.circle([geofence.lat, geofence.lon], { radius: geofence.radius, color: '#00c2a8', fillOpacity: 0.06 }).addTo(map);

document.getElementById('gfLat').value = geofence.lat.toFixed(6);
document.getElementById('gfLon').value = geofence.lon.toFixed(6);
document.getElementById('gfRadius').value = geofence.radius;

document.getElementById('setGfBtn').addEventListener('click', () => {
  const lat = parseFloat(document.getElementById('gfLat').value);
  const lon = parseFloat(document.getElementById('gfLon').value);
  const rad = parseFloat(document.getElementById('gfRadius').value);
  if (isNaN(lat) || isNaN(lon) || isNaN(rad)) { alert('Enter valid numbers'); return; }

  geofence = { lat, lon, radius: rad };
  localStorage.setItem('gfLat', lat);
  localStorage.setItem('gfLon', lon);
  localStorage.setItem('gfRadius', rad);

  siteMarker.setLatLng([lat, lon]).bindPopup('Site center (updated)').setIcon(redIcon);
  fenceCircle.setLatLng([lat, lon]).setRadius(rad).setStyle({ color: '#00c2a8' });

  map.panTo([lat, lon]);
  appendLog(`Geofence set: ${lat}, ${lon} (r=${rad}m)`);
});

document.getElementById('clearGfBtn').addEventListener('click', () => {
  if (fenceCircle) { map.removeLayer(fenceCircle); fenceCircle = null; }
  if (siteMarker) { map.removeLayer(siteMarker); siteMarker = null; }
  localStorage.removeItem('gfLat');
  localStorage.removeItem('gfLon');
  localStorage.removeItem('gfRadius');
  geofence = { lat: null, lon: null, radius: 0 };
  distDisplay.textContent = 'N/A';
  distanceEl.textContent = 'N/A';
  attEl.textContent = 'N/A';
  appendLog('⚪ Geofence cleared');
});

// ========= FETCH LATEST FROM THINGSPEAK =========
async function fetchLatest() {
  try {
    const resp = await fetch(LATEST_URL());
    const data = await resp.json();
    if (!data) return;

    const latestLat = parseFloat(data.field1) || 0;
    const latestLon = parseFloat(data.field2) || 0;
    const workerIDVal = parseInt(data.field3) || 0;
    const hardhatVal = parseInt(data.field4) || 0;
    const checkInVal = data.field5 || '';
    const checkOutVal = data.field6 || '';
    const sosVal = parseInt(data.field7) || 0;

    // Update feed table
    fEls[1].textContent = latestLat.toFixed(6);
    fEls[2].textContent = latestLon.toFixed(6);
    fEls[3].textContent = workerIDVal;
    fEls[4].textContent = hardhatVal;
    fEls[5].textContent = checkInVal;
    fEls[6].textContent = checkOutVal;
    fEls[7].textContent = sosVal;

    // ====== LOCATION, HARDHAT, WORKER ID ======
    workerIdEl.textContent = workerIDVal ? '1' : '0';
    hardhatEl.textContent = hardhatVal ? 'Worn' : 'Not Worn';
    checkInEl.textContent = checkInVal || '—';
    checkOutEl.textContent = checkOutVal || '—';
    sosBadge.textContent = sosVal ? 'SOS Active' : 'Safe';
    sosBadge.className = sosVal ? 'badge danger' : 'badge ok';

    // ====== ATTENDANCE AND DISTANCE BASED ON GEOFENCE ======
    if (latestLat === 0 || latestLon === 0) {
      locationEl.textContent = 'No GPS Available';
      distanceEl.textContent = 'N/A';
      distDisplay.textContent = 'N/A';
      attEl.textContent = 'N/A';
      if (workerMarker) { map.removeLayer(workerMarker); workerMarker = null; }
    } else {
      locationEl.textContent = `${latestLat.toFixed(6)}, ${latestLon.toFixed(6)}`;
      let dist = null;
      if (geofence.lat !== null && geofence.lon !== null) {
        const R = 6371000; // meters
        const dLat = (latestLat - geofence.lat) * Math.PI / 180;
        const dLon = (latestLon - geofence.lon) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(geofence.lat * Math.PI/180) * Math.cos(latestLat * Math.PI/180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        dist = R * c;
        distanceEl.textContent = dist.toFixed(1) + ' m';
        distDisplay.textContent = dist.toFixed(1) + ' m';
        attEl.textContent = dist <= geofence.radius ? 'Present' : 'Absent';
      } else {
        distanceEl.textContent = 'N/A';
        distDisplay.textContent = 'N/A';
        attEl.textContent = 'N/A';
      }

      // Update worker marker
      if (!workerMarker) {
        workerMarker = L.marker([latestLat, latestLon]).addTo(map).bindPopup('Worker');
      } else {
        workerMarker.setLatLng([latestLat, latestLon]);
      }
    }

    lastEl.textContent = new Date(data.created_at).toLocaleTimeString();
    appendLog(`Fetched: WorkerID=${workerIDVal}, Hardhat=${hardhatVal}, SOS=${sosVal}, Lat=${latestLat.toFixed(6)}, Lon=${latestLon.toFixed(6)}`);

  } catch(err) {
    console.error('Fetch error', err);
    appendLog(' Fetch error: ' + err);
  }
}

fetchLatest();
setInterval(fetchLatest, REFRESH_MS);

// ========= THEME TOGGLE =========
document.getElementById('themeToggle').addEventListener('click', ()=>{ document.body.classList.toggle('light'); });
document.getElementById('refreshBtn').addEventListener('click', fetchLatest);
document.getElementById('centerBtn').addEventListener('click', ()=>{ if (workerMarker) map.panTo(workerMarker.getLatLng()); });

</script>
</body>
</html>
